# Forms AI Restyler — Image Support Requirements

## Overview

Many forms look better with images — background images, header/banner images, or focused accent images. This feature adds AI-powered image generation to the form creation flow. Based on the user's prompt and form context, the AI model decides whether images would enhance the form, generates them, and incorporates them into the final design with complementary colors and layout.

---

## Core Concept

The form generation model (Gemini 3 Flash) acts as the creative director. It decides:
1. **Whether** images are needed (not every form benefits from images)
2. **What kind** of images (background, header/banner, focused accent)
3. **What they should look like** (writes the image generation prompt)
4. **How to use them** in the final HTML (placement, sizing, color complementarity)

Image generation is handled by Nano Banana (`gemini-2.5-flash-image`), a dedicated image generation model. Generated images are stored on Vercel Blob for permanent CDN-backed URLs.

---

## User Controls

### "Include images" chip

A toggle chip in the chat toolbar (next to the style guide and screenshot buttons) controls whether AI image generation is enabled.

- **Checked by default** — Gemini may generate images if it decides they would enhance the form
- **Unchecked by user** — Gemini is explicitly told NOT to generate images; the `generate_image` function is not provided in the tool declarations, so the model cannot call it
- The chip state persists for the session
- When unchecked mid-session (after images were already generated), subsequent generations will not include new images. Existing image URLs in `previousHtml` remain unless the model removes them.

This gives creators a simple opt-out without needing to mention it in their prompt.

---

## User Flow

1. Creator pastes a Google Form URL and loads the form
2. Creator types a styling prompt (e.g. "make this a beautiful summer dance workshop registration form")
3. The "Include images" chip is checked (default) — image generation is enabled
4. Gemini analyzes the form context (title, description, questions) + user prompt + optional style guide
5. Gemini decides on the layout and whether images would enhance the form
6. If images are needed, Gemini calls `generate_image` one or more times via function calling — each call includes a tailored image prompt, image type, and color palette
7. Each image is generated by Nano Banana, uploaded to Vercel Blob, and returned to Gemini as both a CDN URL (for embedding) and a vision input (so Gemini can see the actual image)
8. Gemini generates the final HTML with images embedded and theme colors that complement the generated images
9. If no images are needed (or "Include images" is unchecked), Gemini generates HTML directly (no function calls, same as today)

---

## Technical Approach

### Function Calling

Gemini's function calling capability is used to let the model decide when and how to generate images. The model is given a `generate_image` function declaration. In `AUTO` mode, Gemini decides whether to call it (zero, one, or multiple times) based on context.

**Function declaration parameters:**
- `prompt` (string) — the image generation prompt, written by Gemini
- `imageType` (enum: background | header | accent) — how the image will be used
- `colorPalette` (string) — dominant colors the image should use, so Gemini can match form colors
- `aspectRatio` (string) — e.g. "16:9" for headers, "1:1" for accents

**Function response (returned to Gemini):**
- `url` — permanent Vercel Blob CDN URL for embedding in HTML
- `imageType` — echoed back so Gemini knows which image this is
- The generated image itself as `inlineData` (vision input) so Gemini can see the actual result and pick complementary form colors

### Image Generation Model

- **Model:** Nano Banana (`gemini-2.5-flash-image`)
- **API:** Same `@google/generative-ai` SDK, same `GEMINI_API_KEY`
- **Output:** Base64 PNG returned as `inlineData` in the response
- **Cost:** ~$0.039 per image

### Image Storage

- **Service:** Vercel Blob
- **Why:** Permanent CDN-backed URLs that survive redeploys. No Redis size limit concerns (Upstash free tier has 1MB max value size; embedded base64 images would exceed this).
- **Package:** `@vercel/blob`
- **Auth:** `BLOB_READ_WRITE_TOKEN` environment variable
- **URLs:** Public, CDN-backed (e.g. `https://abc.public.blob.vercel-storage.com/header-xyz.png`)
- **TTL:** 30 days. Uploaded images are deleted after 30 days. This aligns with the 7-day TTL on published forms in Redis — images outlive forms but don't accumulate indefinitely. A scheduled cleanup job (e.g. Vercel Cron) or metadata-based expiry can handle this.

### Color Complementarity

Gemini sees the generated image as vision input before producing the final HTML. This allows it to:
- Analyze the actual colors in the generated image
- Pick complementary form colors (background, text, buttons, borders)
- Ensure visual coherence between images and form UI

This is the most reliable approach — no color extraction libraries, no guessing from the prompt.

### Image Types

| Type | Use Case | Aspect Ratio | Style Guidance |
|---|---|---|---|
| `background` | Full-page or section background | Flexible | Subtle, low contrast, should not compete with form content |
| `header` | Top banner image | Wide (16:9 or similar) | Visually striking, sets the mood |
| `accent` | Decorative or content-specific image | Varies | Content-relevant, supports the form theme |

---

## Iterative Refinement

### Subsequent prompts

After the first generation, the user can:
- **"change the header image"** — Gemini calls `generate_image` again, gets a new URL, replaces the old one in HTML
- **"remove the image"** — Gemini generates HTML without the image, no function call
- **"change form colors but keep the image"** — Gemini sees the existing image (re-sent as vision input) and adjusts colors

### Always re-send active images

On every generation call, all active generated images (stored as Blob URLs in client state) are re-fetched and sent to Gemini as vision input alongside `previousHtml`. This ensures:
- Gemini always has visual context of current images
- Color coherence is maintained across edits
- The model can decide to keep, replace, or remove images intelligently

### Orphaned images

When an image is replaced, the old Blob URL becomes orphaned (still stored but no longer referenced). This is acceptable for a prototype. Cleanup can be added later.

---

## System Prompt Additions

The form generation system prompt needs new instructions:

1. **Image decision guidance** — when to generate images (event forms, branded forms) vs. when not to (simple surveys, internal forms)
2. **Image prompt quality** — be specific about style, mood, color palette, composition; avoid text in images; match the form's theme
3. **Background image rules** — use CSS `background-image` with appropriate `background-size: cover`, ensure text remains readable with overlays or contrast
4. **Header image rules** — place at the top, appropriate height, responsive sizing
5. **Color complementarity** — after receiving generated images, pick form colors that complement the image palette

---

## Dependencies

| Dependency | Purpose |
|---|---|
| `@vercel/blob` | Upload generated images to Vercel Blob |
| `@google/generative-ai` (existing) | Function calling + Nano Banana image generation |

## Environment Variables

| Variable | Required | Description |
|---|---|---|
| `GEMINI_API_KEY` | Yes (existing) | Used for both form generation and image generation |
| `BLOB_READ_WRITE_TOKEN` | Yes (new) | Vercel Blob authentication token |

---

## Cost Estimates

| Component | Cost |
|---|---|
| Gemini 3 Flash (form generation) | ~$0.01-0.03 per call |
| Nano Banana (per image) | ~$0.039 per image |
| Gemini vision (re-sent images) | ~negligible (258 tokens/image) |
| Vercel Blob storage | Free at prototype scale |
| **Typical generation with 1-2 images** | **~$0.10-0.15** |

---

## Out of Scope (for now)

- Image editing (modifying existing images rather than regenerating)
- Image quality/style selection by user (e.g. "photographic" vs "illustration")
- Blob cleanup for orphaned images
- Streaming progress indicators during image generation
- User-provided images as form content (separate from style guide)
